<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Auto Buy Bot</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            color: white;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        .panel {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        h2 {
            color: #667eea;
            margin-bottom: 20px;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        input[type="text"],
        input[type="number"],
        select,
        textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        textarea {
            min-height: 150px;
            font-family: 'Courier New', monospace;
            resize: vertical;
        }
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        .btn:active {
            transform: translateY(0);
        }
        .btn-secondary {
            background: #6c757d;
        }
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .file-upload {
            border: 2px dashed #667eea;
            padding: 30px;
            text-align: center;
            border-radius: 8px;
            background: #f8f9ff;
            cursor: pointer;
            transition: background 0.3s;
        }
        .file-upload:hover {
            background: #eef0ff;
        }
        .file-upload input[type="file"] {
            display: none;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        .stat-card h3 {
            font-size: 2em;
            margin-bottom: 5px;
        }
        .stat-card p {
            opacity: 0.9;
        }
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .checkbox-group input[type="checkbox"] {
            width: auto;
            height: 20px;
            width: 20px;
        }
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .tab {
            padding: 10px 20px;
            background: #f0f0f0;
            border: none;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s;
        }
        .tab.active {
            background: white;
            color: #667eea;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .key-preview {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üõ†Ô∏è Admin Panel - Auto Buy Bot</h1>

        <div class="panel">
            <div id="alert" class="alert" style="display: none; position: relative;"></div>
            
            <div class="stats" id="stats">
                <div class="stat-card">
                    <h3 id="totalProducts">-</h3>
                    <p>S·∫£n ph·∫©m</p>
                </div>
                <div class="stat-card">
                    <h3 id="totalKeys">-</h3>
                    <p>Keys t·ªïng</p>
                </div>
                <div class="stat-card">
                    <h3 id="availableKeys">-</h3>
                    <p>Keys c√≤n l·∫°i</p>
                </div>
            </div>

            <div class="tabs">
                <button class="tab active" onclick="switchTab('category')">Danh m·ª•c</button>
                <button class="tab" onclick="switchTab('product')">S·∫£n ph·∫©m</button>
                <button class="tab" onclick="switchTab('keys')">Nh·∫≠p Keys</button>
                <button class="tab" onclick="switchTab('bulk')">Nh·∫≠p h√†ng lo·∫°t</button>
                <button class="tab" onclick="switchTab('viewkeys')">Xem Keys</button>
                <button class="tab" onclick="switchTab('coupons')">M√£ gi·∫£m gi√°</button>
                <button class="tab" onclick="switchTab('manage')">Qu·∫£n l√Ω & X√≥a</button>
            </div>

            <!-- Category Tab -->
            <div id="category-tab" class="tab-content active">
                <h2>‚ûï Th√™m danh m·ª•c m·ªõi</h2>
                <form id="categoryForm">
                    <div class="form-group">
                        <label for="catName">T√™n danh m·ª•c:</label>
                        <input type="text" id="catName" placeholder="V√≠ d·ª•: Cheats, Spotify Premium..." required>
                    </div>
                    <div class="form-group checkbox-group">
                        <input type="checkbox" id="catActive" checked>
                        <label for="catActive">K√≠ch ho·∫°t ngay</label>
                    </div>
                    <button type="submit" class="btn">T·∫°o danh m·ª•c</button>
                </form>
            </div>

            <!-- Product Tab -->
            <div id="product-tab" class="tab-content">
                <h2>‚ûï Th√™m s·∫£n ph·∫©m m·ªõi</h2>
                <form id="productForm">
                    <div class="form-group">
                        <label for="productName">T√™n s·∫£n ph·∫©m:</label>
                        <input type="text" id="productName" placeholder="V√≠ d·ª•: Valorant Cheat 1 th√°ng" required>
                    </div>
                    <div class="form-group">
                        <label for="productPrice">Gi√° (VNƒê):</label>
                        <input type="number" id="productPrice" placeholder="70000" min="0" required>
                    </div>
                    <div class="form-group">
                        <label for="productDiscount">Gi·∫£m gi√° (%):</label>
                        <input type="number" id="productDiscount" placeholder="0" min="0" max="100" value="0">
                        <small style="color: #666; font-size: 12px;">0 = Kh√¥ng gi·∫£m gi√°. V√≠ d·ª•: 20 = gi·∫£m 20%</small>
                    </div>
                    <div class="form-group">
                        <label for="productCategory">Danh m·ª•c:</label>
                        <select id="productCategory">
                            <option value="">Kh√¥ng ch·ªçn</option>
                        </select>
                    </div>
                    <div class="form-group checkbox-group">
                        <input type="checkbox" id="productActive" checked>
                        <label for="productActive">K√≠ch ho·∫°t ngay</label>
                    </div>
                    <button type="submit" class="btn">T·∫°o s·∫£n ph·∫©m</button>
                </form>
            </div>

            <!-- Keys Tab -->
            <div id="keys-tab" class="tab-content">
                <h2>üîë Nh·∫≠p keys cho s·∫£n ph·∫©m</h2>
                <form id="keysForm">
                    <div class="form-group">
                        <label for="keyProduct">Ch·ªçn s·∫£n ph·∫©m:</label>
                        <select id="keyProduct" required>
                            <option value="">-- Ch·ªçn s·∫£n ph·∫©m --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="keysList">Danh s√°ch keys (m·ªói d√≤ng 1 key):</label>
                        <textarea id="keysList" placeholder="KEY-XXXX-XXXX-XXXX&#10;KEY-YYYY-YYYY-YYYY&#10;KEY-ZZZZ-ZZZZ-ZZZZ" required></textarea>
                        <div class="key-preview" id="keyPreview"></div>
                    </div>
                    <button type="submit" class="btn">Nh·∫≠p keys</button>
                </form>
            </div>

            <!-- Bulk Import Tab -->
            <div id="bulk-tab" class="tab-content">
                <h2>üì¶ Nh·∫≠p h√†ng lo·∫°t t·ª´ file</h2>
                <div class="form-group">
                    <label for="bulkProduct">Ch·ªçn s·∫£n ph·∫©m:</label>
                    <select id="bulkProduct" required>
                        <option value="">-- Ch·ªçn s·∫£n ph·∫©m --</option>
                    </select>
                </div>
                <div class="file-upload" onclick="document.getElementById('fileInput').click()">
                    <input type="file" id="fileInput" accept=".txt,.csv" onchange="handleFileUpload(event)">
                    <p>üìÅ K√©o th·∫£ file ho·∫∑c click ƒë·ªÉ ch·ªçn</p>
                    <p style="font-size: 12px; opacity: 0.7; margin-top: 10px;">H·ªó tr·ª£ .txt v√† .csv (m·ªói d√≤ng 1 key)</p>
                </div>
                <div id="filePreview" style="margin-top: 20px;"></div>
                <button id="bulkUploadBtn" class="btn" onclick="uploadBulkKeys()" style="display: none; margin-top: 20px;">
                    Upload Keys
                </button>
            </div>

            <!-- View All Keys Tab -->
            <div id="viewkeys-tab" class="tab-content">
                <h2>üîç Xem T·∫•t C·∫£ Keys</h2>
                
                <!-- Filter Controls -->
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div class="form-group">
                            <label>L·ªçc theo s·∫£n ph·∫©m:</label>
                            <select id="filterProduct" onchange="filterKeys()">
                                <option value="">T·∫•t c·∫£ s·∫£n ph·∫©m</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>L·ªçc theo tr·∫°ng th√°i:</label>
                            <select id="filterStatus" onchange="filterKeys()">
                                <option value="">T·∫•t c·∫£</option>
                                <option value="unsold">Ch·ªâ ch∆∞a b√°n</option>
                                <option value="sold">Ch·ªâ ƒë√£ b√°n</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>T√¨m ki·∫øm key:</label>
                            <input type="text" id="searchKey" placeholder="T√¨m key..." oninput="filterKeys()">
                        </div>
                    </div>
                    <button class="btn" onclick="loadAllKeys()" style="margin-top: 10px;">üîÑ T·∫£i l·∫°i danh s√°ch</button>
                </div>

                <!-- Keys Display -->
                <div id="allKeysList" style="margin-top: 20px;"></div>
            </div>

            <!-- Coupons Tab -->
            <div id="coupons-tab" class="tab-content">
                <h2>üéüÔ∏è Qu·∫£n l√Ω m√£ gi·∫£m gi√°</h2>
                
                <!-- Create Coupon Form -->
                <div class="panel">
                    <h3>‚ûï T·∫°o m√£ gi·∫£m gi√° m·ªõi</h3>
                    <form id="couponForm">
                        <div class="form-group">
                            <label for="couponCode">M√£ gi·∫£m gi√°:</label>
                            <input type="text" id="couponCode" placeholder="VD: SALE20, DISCOUNT50" style="text-transform: uppercase" required>
                            <small style="color: #666; font-size: 12px;">T·ª± ƒë·ªông chuy·ªÉn th√†nh ch·ªØ IN HOA</small>
                        </div>
                        <div class="form-group">
                            <label for="couponDiscount">% Gi·∫£m gi√°:</label>
                            <input type="number" id="couponDiscount" placeholder="20" min="1" max="100" required>
                        </div>
                        <div class="form-group">
                            <label for="couponMaxUses">S·ªë l·∫ßn s·ª≠ d·ª•ng t·ªëi ƒëa:</label>
                            <input type="number" id="couponMaxUses" placeholder="-1 = Kh√¥ng gi·ªõi h·∫°n" value="-1">
                            <small style="color: #666; font-size: 12px;">-1 = Kh√¥ng gi·ªõi h·∫°n, >0 = Gi·ªõi h·∫°n s·ªë l·∫ßn</small>
                        </div>
                        <div class="form-group">
                            <label for="couponExpiry">Ng√†y h·∫øt h·∫°n (T√πy ch·ªçn):</label>
                            <input type="datetime-local" id="couponExpiry">
                            <small style="color: #666; font-size: 12px;">ƒê·ªÉ tr·ªëng = Kh√¥ng h·∫øt h·∫°n</small>
                        </div>
                        <div class="form-group checkbox-group">
                            <input type="checkbox" id="couponActive" checked>
                            <label for="couponActive">K√≠ch ho·∫°t ngay</label>
                        </div>
                        <button type="submit" class="btn">T·∫°o m√£ gi·∫£m gi√°</button>
                    </form>
                </div>

                <!-- List Coupons -->
                <div class="panel" style="margin-top: 20px;">
                    <h3>üìã Danh s√°ch m√£ gi·∫£m gi√°</h3>
                    <button onclick="loadCoupons()" class="btn" style="margin-bottom: 15px;">üîÑ T·∫£i l·∫°i danh s√°ch</button>
                    <div id="couponsList"></div>
                </div>
            </div>

            <!-- Manage & Delete Tab -->
            <div id="manage-tab" class="tab-content">
                <h2>üóëÔ∏è Qu·∫£n l√Ω & X√≥a</h2>
                
                <div class="panel" style="background: #fff3cd; border: 2px solid #ffc107; margin-bottom: 20px;">
                    <p style="color: #856404; margin: 0;">‚ö†Ô∏è <strong>C·∫£nh b√°o:</strong> X√≥a l√† vƒ©nh vi·ªÖn v√† kh√¥ng th·ªÉ ho√†n t√°c!</p>
                </div>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                    <!-- Delete Category -->
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                        <h3 style="color: #dc3545; margin-top: 0;">üóëÔ∏è X√≥a danh m·ª•c</h3>
                        <div class="form-group">
                            <label>Ch·ªçn danh m·ª•c:</label>
                            <select id="deleteCategorySelect">
                                <option value="">-- Ch·ªçn danh m·ª•c --</option>
                            </select>
                        </div>
                        <button class="btn" style="background: #dc3545;" onclick="deleteCategory()">
                            X√≥a danh m·ª•c
                        </button>
                        <p style="font-size: 12px; opacity: 0.7; margin-top: 10px;">
                            * S·∫£n ph·∫©m trong danh m·ª•c s·∫Ω chuy·ªÉn v·ªÅ "Kh√¥ng danh m·ª•c"
                        </p>
                    </div>

                    <!-- Delete Product -->
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                        <h3 style="color: #dc3545; margin-top: 0;">üóëÔ∏è X√≥a s·∫£n ph·∫©m</h3>
                        <div class="form-group">
                            <label>Ch·ªçn s·∫£n ph·∫©m:</label>
                            <select id="deleteProductSelect">
                                <option value="">-- Ch·ªçn s·∫£n ph·∫©m --</option>
                            </select>
                        </div>
                        <button class="btn" style="background: #dc3545;" onclick="deleteProduct()">
                            X√≥a s·∫£n ph·∫©m
                        </button>
                        <p style="font-size: 12px; opacity: 0.7; margin-top: 10px;">
                            * T·∫•t c·∫£ keys c·ªßa s·∫£n ph·∫©m c≈©ng s·∫Ω b·ªã x√≥a
                        </p>
                    </div>

                    <!-- Delete Keys -->
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                        <h3 style="color: #dc3545; margin-top: 0;">üóëÔ∏è X√≥a keys</h3>
                        <div class="form-group">
                            <label>Ch·ªçn s·∫£n ph·∫©m:</label>
                            <select id="deleteKeysProductSelect">
                                <option value="">-- Ch·ªçn s·∫£n ph·∫©m --</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>X√≥a lo·∫°i n√†o:</label>
                            <select id="deleteKeysType">
                                <option value="all">T·∫•t c·∫£ keys</option>
                                <option value="sold">Ch·ªâ keys ƒë√£ b√°n</option>
                                <option value="unsold">Ch·ªâ keys ch∆∞a b√°n</option>
                            </select>
                        </div>
                        <button class="btn" style="background: #dc3545;" onclick="deleteKeys()">
                            X√≥a keys
                        </button>
                    </div>
                </div>

                <!-- View & Delete Individual Keys -->
                <div style="margin-top: 30px; background: #f8f9fa; padding: 20px; border-radius: 10px;">
                    <h3 style="color: #667eea; margin-top: 0;">üìã Xem, S·ª≠a & X√≥a Keys</h3>
                    <div class="form-group">
                        <label>Ch·ªçn s·∫£n ph·∫©m:</label>
                        <select id="viewKeysProductSelect" onchange="loadKeysForProduct()">
                            <option value="">-- Ch·ªçn s·∫£n ph·∫©m --</option>
                        </select>
                    </div>
                    <div id="keysList" style="margin-top: 20px;"></div>
                </div>

                <!-- Replace Key -->
                <div style="margin-top: 30px; background: #fff3cd; padding: 20px; border-radius: 10px; border: 2px solid #ffc107;">
                    <h3 style="color: #856404; margin-top: 0;">üîÑ Thay th·∫ø Key</h3>
                    <p style="font-size: 14px; margin-bottom: 20px;">T√¨m v√† thay th·∫ø key c≈© b·∫±ng key m·ªõi (ch·ªâ key ch∆∞a b√°n)</p>
                    <form id="replaceKeyForm" style="display: grid; gap: 15px;">
                        <div class="form-group">
                            <label>Ch·ªçn s·∫£n ph·∫©m:</label>
                            <select id="replaceProductSelect" required>
                                <option value="">-- Ch·ªçn s·∫£n ph·∫©m --</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Key c≈© (c·∫ßn thay th·∫ø):</label>
                            <input type="text" id="replaceOldKey" placeholder="KEY-OLD-XXXX-XXXX" required>
                        </div>
                        <div class="form-group">
                            <label>Key m·ªõi:</label>
                            <input type="text" id="replaceNewKey" placeholder="KEY-NEW-YYYY-YYYY" required>
                        </div>
                        <button type="submit" class="btn" style="background: #ffc107; color: #000;">
                            üîÑ Thay th·∫ø Key
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin;
        let fileContent = null;

        // Load initial data
        async function loadStats() {
            try {
                const res = await fetch(`${API_BASE}/admin/stats`);
                const data = await res.json();
                document.getElementById('totalProducts').textContent = data.totalProducts;
                document.getElementById('totalKeys').textContent = data.totalKeys;
                document.getElementById('availableKeys').textContent = data.availableKeys;
            } catch (e) {
                console.error('Load stats error:', e);
            }
        }

        async function loadCategories() {
            try {
                const res = await fetch(`${API_BASE}/admin/categories`);
                const categories = await res.json();
                const select = document.getElementById('productCategory');
                select.innerHTML = '<option value="">Kh√¥ng ch·ªçn</option>';
                categories.forEach(cat => {
                    select.innerHTML += `<option value="${cat.id}">${cat.name}</option>`;
                });
            } catch (e) {
                console.error('Load categories error:', e);
            }
        }

        async function loadProducts() {
            try {
                const res = await fetch(`${API_BASE}/admin/products`);
                const products = await res.json();
                const selects = [
                    document.getElementById('keyProduct'), 
                    document.getElementById('bulkProduct'),
                    document.getElementById('deleteProductSelect'),
                    document.getElementById('deleteKeysProductSelect'),
                    document.getElementById('viewKeysProductSelect'),
                    document.getElementById('replaceProductSelect'),
                    document.getElementById('filterProduct')
                ];
                selects.forEach(select => {
                    if (select) {
                        const isFilter = select.id === 'filterProduct';
                        select.innerHTML = isFilter ? '<option value="">T·∫•t c·∫£ s·∫£n ph·∫©m</option>' : '<option value="">-- Ch·ªçn s·∫£n ph·∫©m --</option>';
                        products.forEach(p => {
                            select.innerHTML += `<option value="${p.id}">${p.name} (ID: ${p.id}) - ${p.price.toLocaleString()}ƒë</option>`;
                        });
                    }
                });
            } catch (e) {
                console.error('Load products error:', e);
            }
        }

        // Global variable to store all keys
        let allKeysData = [];

        async function loadAllKeys() {
            try {
                const res = await fetch(`${API_BASE}/admin/allkeys`);
                if (!res.ok) {
                    throw new Error(`HTTP ${res.status}`);
                }
                const text = await res.text();
                allKeysData = JSON.parse(text);
                filterKeys();
            } catch (e) {
                console.error('Load keys error:', e);
                document.getElementById('allKeysList').innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <p style="color: #666; margin: 10px 0;">‚ö†Ô∏è Kh√¥ng th·ªÉ t·∫£i danh s√°ch keys</p>
                        <button onclick="loadAllKeys()" class="btn" style="margin-top: 10px;">üîÑ Th·ª≠ l·∫°i</button>
                    </div>
                `;
            }
        }

        function filterKeys() {
            const filterProduct = document.getElementById('filterProduct').value;
            const filterStatus = document.getElementById('filterStatus').value;
            const searchKey = document.getElementById('searchKey').value.toLowerCase();

            let filtered = allKeysData.filter(k => {
                const matchProduct = !filterProduct || k.product_id == filterProduct;
                const matchStatus = !filterStatus || 
                    (filterStatus === 'sold' && k.is_sold === 1) || 
                    (filterStatus === 'unsold' && k.is_sold === 0);
                const matchSearch = !searchKey || k.key.toLowerCase().includes(searchKey);
                return matchProduct && matchStatus && matchSearch;
            });

            displayKeys(filtered);
        }

        function displayKeys(keys) {
            const container = document.getElementById('allKeysList');
            
            if (keys.length === 0) {
                container.innerHTML = '<p style="text-align: center; opacity: 0.7;">Kh√¥ng t√¨m th·∫•y key n√†o</p>';
                return;
            }

            const unsold = keys.filter(k => k.is_sold === 0);
            const sold = keys.filter(k => k.is_sold === 1);

            container.innerHTML = `
                <div style="margin-bottom: 30px;">
                    <h3 style="color: #28a745;">‚úÖ Keys ch∆∞a b√°n (${unsold.length})</h3>
                    <div style="max-height: 500px; overflow-y: auto; background: white; padding: 15px; border-radius: 10px;">
                        ${unsold.length === 0 ? '<p style="opacity: 0.7;">Kh√¥ng c√≥</p>' : unsold.map(k => `
                            <div id="allkey-row-${k.id}" style="display: grid; grid-template-columns: 150px 1fr auto; gap: 10px; align-items: center; padding: 12px; background: #f8f9fa; margin-bottom: 8px; border-radius: 8px; border: 2px solid #e9ecef;">
                                <div>
                                    <strong style="color: #667eea;">${k.product_name || 'Unknown'}</strong>
                                    <div style="font-size: 11px; color: #6c757d;">ID: ${k.product_id} | Key ID: ${k.id}</div>
                                </div>
                                <input 
                                    type="text" 
                                    id="allkey-input-${k.id}" 
                                    value="${k.key}" 
                                    style="flex: 1; padding: 10px; border: 2px solid #ddd; border-radius: 5px; font-family: 'Courier New', monospace; font-size: 13px;"
                                    readonly
                                />
                                <div style="display: flex; gap: 5px;">
                                    <button onclick="enableEditAll(${k.id})" id="alledit-btn-${k.id}" style="background: #007bff; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; white-space: nowrap; font-size: 13px;">
                                        ‚úèÔ∏è S·ª≠a
                                    </button>
                                    <button onclick="saveKeyAll(${k.id})" id="allsave-btn-${k.id}" style="display: none; background: #28a745; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; white-space: nowrap; font-size: 13px;">
                                        üíæ L∆∞u
                                    </button>
                                    <button onclick="cancelEditAll(${k.id}, '${k.key}')" id="allcancel-btn-${k.id}" style="display: none; background: #6c757d; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; white-space: nowrap; font-size: 13px;">
                                        ‚ùå
                                    </button>
                                    <button onclick="deleteKeyAll(${k.id}, '${k.key}')" style="background: #dc3545; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; white-space: nowrap; font-size: 13px;">
                                        üóëÔ∏è
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                <div>
                    <h3 style="color: #6c757d;">‚ùå Keys ƒë√£ b√°n (${sold.length})</h3>
                    <div style="max-height: 300px; overflow-y: auto; background: white; padding: 15px; border-radius: 10px;">
                        ${sold.length === 0 ? '<p style="opacity: 0.7;">Kh√¥ng c√≥</p>' : sold.map(k => `
                            <div style="display: grid; grid-template-columns: 150px 1fr auto; gap: 10px; align-items: center; padding: 12px; background: #f8f9fa; margin-bottom: 8px; border-radius: 8px; opacity: 0.6;">
                                <div>
                                    <strong style="color: #6c757d;">${k.product_name || 'Unknown'}</strong>
                                    <div style="font-size: 11px; color: #6c757d;">ID: ${k.product_id} | Key ID: ${k.id}</div>
                                </div>
                                <code style="padding: 10px; font-family: 'Courier New', monospace; font-size: 13px;">${k.key}</code>
                                <button onclick="deleteKeyAll(${k.id}, '${k.key}')" style="background: #dc3545; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; white-space: nowrap; font-size: 13px;">
                                    üóëÔ∏è
                                </button>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function enableEditAll(keyId) {
            const input = document.getElementById(`allkey-input-${keyId}`);
            const editBtn = document.getElementById(`alledit-btn-${keyId}`);
            const saveBtn = document.getElementById(`allsave-btn-${keyId}`);
            const cancelBtn = document.getElementById(`allcancel-btn-${keyId}`);
            
            input.readOnly = false;
            input.style.borderColor = '#007bff';
            input.style.background = 'white';
            input.focus();
            input.select();
            
            editBtn.style.display = 'none';
            saveBtn.style.display = 'block';
            cancelBtn.style.display = 'block';
        }

        function cancelEditAll(keyId, originalKey) {
            const input = document.getElementById(`allkey-input-${keyId}`);
            const editBtn = document.getElementById(`alledit-btn-${keyId}`);
            const saveBtn = document.getElementById(`allsave-btn-${keyId}`);
            const cancelBtn = document.getElementById(`allcancel-btn-${keyId}`);
            
            input.value = originalKey;
            input.readOnly = true;
            input.style.borderColor = '#ddd';
            input.style.background = '#f8f9fa';
            
            editBtn.style.display = 'block';
            saveBtn.style.display = 'none';
            cancelBtn.style.display = 'none';
        }

        async function saveKeyAll(keyId) {
            const input = document.getElementById(`allkey-input-${keyId}`);
            const newKey = input.value.trim();
            
            if (!newKey) {
                showAlert('‚ùå Key kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng', 'error');
                return;
            }
            
            try {
                const res = await fetch(`${API_BASE}/admin/key/${keyId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ newKey })
                });
                const data = await res.json();
                
                if (data.ok) {
                    showAlert(`‚úÖ ƒê√£ c·∫≠p nh·∫≠t key: ${data.oldKey} ‚Üí ${data.newKey}`);
                    
                    // Update in local data
                    const keyData = allKeysData.find(k => k.id === keyId);
                    if (keyData) keyData.key = newKey;
                    
                    input.readOnly = true;
                    input.style.borderColor = '#ddd';
                    input.style.background = '#f8f9fa';
                    
                    document.getElementById(`alledit-btn-${keyId}`).style.display = 'block';
                    document.getElementById(`allsave-btn-${keyId}`).style.display = 'none';
                    document.getElementById(`allcancel-btn-${keyId}`).style.display = 'none';
                    
                    // Update cancel button
                    const cancelBtn = document.getElementById(`allcancel-btn-${keyId}`);
                    cancelBtn.setAttribute('onclick', `cancelEditAll(${keyId}, '${newKey}')`);
                    
                    loadStats();
                } else {
                    showAlert(`‚ùå L·ªói: ${data.error}`, 'error');
                }
            } catch (e) {
                showAlert(`‚ùå L·ªói k·∫øt n·ªëi: ${e.message}`, 'error');
            }
        }

        async function deleteKeyAll(keyId, keyText) {
            if (!confirm(`‚ö†Ô∏è X√≥a key: ${keyText}?`)) {
                return;
            }

            try {
                const res = await fetch(`${API_BASE}/admin/key/${keyId}`, {
                    method: 'DELETE'
                });
                const data = await res.json();
                if (data.ok) {
                    showAlert(`‚úÖ ƒê√£ x√≥a key`);
                    
                    // Remove from local data
                    allKeysData = allKeysData.filter(k => k.id !== keyId);
                    filterKeys();
                    loadStats();
                } else {
                    showAlert(`‚ùå L·ªói: ${data.error}`, 'error');
                }
            } catch (e) {
                showAlert(`‚ùå L·ªói k·∫øt n·ªëi: ${e.message}`, 'error');
            }
        }

        async function loadCategoriesForDelete() {
            try {
                const res = await fetch(`${API_BASE}/admin/categories`);
                const categories = await res.json();
                const select = document.getElementById('deleteCategorySelect');
                if (select) {
                    select.innerHTML = '<option value="">-- Ch·ªçn danh m·ª•c --</option>';
                    categories.forEach(cat => {
                        select.innerHTML += `<option value="${cat.id}">${cat.name} (ID: ${cat.id})</option>`;
                    });
                }
            } catch (e) {
                console.error('Load categories error:', e);
            }
        }

        function showAlert(message, type = 'success') {
            const alert = document.getElementById('alert');
            alert.className = `alert alert-${type}`;
            alert.innerHTML = `
                ${message}
                <button onclick="this.parentElement.style.display='none'" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; font-size: 20px; cursor: pointer; color: inherit; opacity: 0.8; padding: 0; width: 24px; height: 24px;">√ó</button>
            `;
            alert.style.display = 'block';
            setTimeout(() => {
                alert.style.display = 'none';
            }, 3000);
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(`${tabName}-tab`).classList.add('active');
        }

        // Category Form
        document.getElementById('categoryForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('catName').value;
            const active = document.getElementById('catActive').checked;

            try {
                const res = await fetch(`${API_BASE}/admin/category`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, active })
                });
                const data = await res.json();
                if (data.ok) {
                    showAlert(`‚úÖ ƒê√£ t·∫°o danh m·ª•c "${name}" (ID: ${data.id})`);
                    document.getElementById('categoryForm').reset();
                    document.getElementById('catActive').checked = true;
                    loadCategories();
                    loadStats();
                } else {
                    showAlert(`‚ùå L·ªói: ${data.error}`, 'error');
                }
            } catch (e) {
                showAlert(`‚ùå L·ªói k·∫øt n·ªëi: ${e.message}`, 'error');
            }
        });

        // Product Form
        document.getElementById('productForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('productName').value;
            const price = parseInt(document.getElementById('productPrice').value);
            const discount = parseInt(document.getElementById('productDiscount').value) || 0;
            const active = document.getElementById('productActive').checked;
            const categoryId = document.getElementById('productCategory').value || null;

            try {
                const res = await fetch(`${API_BASE}/admin/product`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, price, discount, active, categoryId })
                });
                const data = await res.json();
                if (data.ok) {
                    const finalPrice = discount > 0 ? Math.floor(price * (100 - discount) / 100) : price;
                    const priceStr = discount > 0 
                        ? `${price.toLocaleString()}ƒë ‚Üí ${finalPrice.toLocaleString()}ƒë (-${discount}%)`
                        : `${price.toLocaleString()}ƒë`;
                    showAlert(`‚úÖ ƒê√£ t·∫°o s·∫£n ph·∫©m "${name}" (ID: ${data.id}) - ${priceStr}`);
                    document.getElementById('productForm').reset();
                    document.getElementById('productActive').checked = true;
                    document.getElementById('productDiscount').value = 0;
                    loadProducts();
                    loadStats();
                } else {
                    showAlert(`‚ùå L·ªói: ${data.error}`, 'error');
                }
            } catch (e) {
                showAlert(`‚ùå L·ªói k·∫øt n·ªëi: ${e.message}`, 'error');
            }
        });

        // Keys Form
        document.getElementById('keysList').addEventListener('input', (e) => {
            const keys = e.target.value.split('\n').filter(k => k.trim());
            document.getElementById('keyPreview').textContent = 
                `üìä T·ªïng: ${keys.length} keys${keys.length > 0 ? '\n\nPreview:\n' + keys.slice(0, 5).join('\n') + (keys.length > 5 ? '\n...' : '') : ''}`;
        });

        document.getElementById('keysForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const productId = parseInt(document.getElementById('keyProduct').value);
            const keysText = document.getElementById('keysList').value;
            const keys = keysText.split('\n').filter(k => k.trim());

            if (keys.length === 0) {
                showAlert('‚ùå Vui l√≤ng nh·∫≠p √≠t nh·∫•t 1 key', 'error');
                return;
            }

            try {
                const res = await fetch(`${API_BASE}/admin/keys`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ productId, keys })
                });
                const data = await res.json();
                if (data.ok) {
                    showAlert(`‚úÖ ƒê√£ nh·∫≠p ${data.count} keys cho s·∫£n ph·∫©m ID ${productId}`);
                    document.getElementById('keysForm').reset();
                    document.getElementById('keyPreview').textContent = '';
                    loadStats();
                } else {
                    showAlert(`‚ùå L·ªói: ${data.error}`, 'error');
                }
            } catch (e) {
                showAlert(`‚ùå L·ªói k·∫øt n·ªëi: ${e.message}`, 'error');
            }
        });

        // File Upload
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                fileContent = e.target.result;
                const keys = fileContent.split('\n').filter(k => k.trim());
                document.getElementById('filePreview').innerHTML = `
                    <div style="background: #d4edda; padding: 15px; border-radius: 8px; color: #155724;">
                        <strong>üìÑ File: ${file.name}</strong><br>
                        <strong>üìä T·ªïng keys: ${keys.length}</strong><br>
                        <div style="margin-top: 10px; font-family: monospace; font-size: 12px; max-height: 150px; overflow-y: auto;">
                            ${keys.slice(0, 10).join('<br>')}
                            ${keys.length > 10 ? '<br>...' : ''}
                        </div>
                    </div>
                `;
                document.getElementById('bulkUploadBtn').style.display = 'block';
            };
            reader.readAsText(file);
        }

        async function uploadBulkKeys() {
            const productId = parseInt(document.getElementById('bulkProduct').value);
            if (!productId) {
                showAlert('‚ùå Vui l√≤ng ch·ªçn s·∫£n ph·∫©m', 'error');
                return;
            }
            if (!fileContent) {
                showAlert('‚ùå Vui l√≤ng ch·ªçn file', 'error');
                return;
            }

            const keys = fileContent.split('\n').filter(k => k.trim());
            try {
                const res = await fetch(`${API_BASE}/admin/keys`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ productId, keys })
                });
                const data = await res.json();
                if (data.ok) {
                    showAlert(`‚úÖ ƒê√£ upload ${data.count} keys cho s·∫£n ph·∫©m ID ${productId}`);
                    document.getElementById('fileInput').value = '';
                    document.getElementById('filePreview').innerHTML = '';
                    document.getElementById('bulkUploadBtn').style.display = 'none';
                    fileContent = null;
                    loadStats();
                } else {
                    showAlert(`‚ùå L·ªói: ${data.error}`, 'error');
                }
            } catch (e) {
                showAlert(`‚ùå L·ªói k·∫øt n·ªëi: ${e.message}`, 'error');
            }
        }

        // Delete functions
        async function deleteCategory() {
            const categoryId = document.getElementById('deleteCategorySelect').value;
            if (!categoryId) {
                showAlert('‚ùå Vui l√≤ng ch·ªçn danh m·ª•c', 'error');
                return;
            }

            if (!confirm('‚ö†Ô∏è B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a danh m·ª•c n√†y?\nS·∫£n ph·∫©m trong danh m·ª•c s·∫Ω chuy·ªÉn v·ªÅ "Kh√¥ng danh m·ª•c".')) {
                return;
            }

            try {
                const res = await fetch(`${API_BASE}/admin/category/${categoryId}`, {
                    method: 'DELETE'
                });
                const data = await res.json();
                if (data.ok) {
                    showAlert(`‚úÖ ƒê√£ x√≥a danh m·ª•c ID ${categoryId}`);
                    document.getElementById('deleteCategorySelect').value = '';
                    loadCategories();
                    loadCategoriesForDelete();
                    loadStats();
                } else {
                    showAlert(`‚ùå L·ªói: ${data.error}`, 'error');
                }
            } catch (e) {
                showAlert(`‚ùå L·ªói k·∫øt n·ªëi: ${e.message}`, 'error');
            }
        }

        async function deleteProduct() {
            const productId = document.getElementById('deleteProductSelect').value;
            if (!productId) {
                showAlert('‚ùå Vui l√≤ng ch·ªçn s·∫£n ph·∫©m', 'error');
                return;
            }

            if (!confirm('‚ö†Ô∏è B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a s·∫£n ph·∫©m n√†y?\nT·∫•t c·∫£ keys c·ªßa s·∫£n ph·∫©m c≈©ng s·∫Ω b·ªã x√≥a vƒ©nh vi·ªÖn!')) {
                return;
            }

            try {
                const res = await fetch(`${API_BASE}/admin/product/${productId}`, {
                    method: 'DELETE'
                });
                const data = await res.json();
                if (data.ok) {
                    showAlert(`‚úÖ ƒê√£ x√≥a s·∫£n ph·∫©m ID ${productId} (v√† ${data.keysDeleted} keys)`);
                    document.getElementById('deleteProductSelect').value = '';
                    loadProducts();
                    loadStats();
                } else {
                    showAlert(`‚ùå L·ªói: ${data.error}`, 'error');
                }
            } catch (e) {
                showAlert(`‚ùå L·ªói k·∫øt n·ªëi: ${e.message}`, 'error');
            }
        }

        async function deleteKeys() {
            const productId = document.getElementById('deleteKeysProductSelect').value;
            const type = document.getElementById('deleteKeysType').value;
            
            if (!productId) {
                showAlert('‚ùå Vui l√≤ng ch·ªçn s·∫£n ph·∫©m', 'error');
                return;
            }

            const typeText = type === 'all' ? 'T·∫§T C·∫¢ keys' : 
                           type === 'sold' ? 'keys ƒê√É B√ÅN' : 'keys CH∆ØA B√ÅN';
            
            if (!confirm(`‚ö†Ô∏è B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ${typeText} c·ªßa s·∫£n ph·∫©m n√†y?`)) {
                return;
            }

            try {
                const onlySold = type === 'sold' ? 'true' : type === 'unsold' ? 'false' : '';
                const res = await fetch(`${API_BASE}/admin/keys/${productId}${onlySold ? '?onlySold=' + onlySold : ''}`, {
                    method: 'DELETE'
                });
                const data = await res.json();
                if (data.ok) {
                    showAlert(`‚úÖ ƒê√£ x√≥a ${data.deleted} keys`);
                    document.getElementById('deleteKeysProductSelect').value = '';
                    loadStats();
                    if (document.getElementById('viewKeysProductSelect').value == productId) {
                        loadKeysForProduct();
                    }
                } else {
                    showAlert(`‚ùå L·ªói: ${data.error}`, 'error');
                }
            } catch (e) {
                showAlert(`‚ùå L·ªói k·∫øt n·ªëi: ${e.message}`, 'error');
            }
        }

        async function loadKeysForProduct() {
            const productId = document.getElementById('viewKeysProductSelect').value;
            const keysList = document.getElementById('keysList');
            
            if (!productId) {
                keysList.innerHTML = '';
                return;
            }

            try {
                const res = await fetch(`${API_BASE}/admin/keys/${productId}`);
                const keys = await res.json();
                
                if (keys.length === 0) {
                    keysList.innerHTML = '<p style="text-align: center; opacity: 0.7;">Kh√¥ng c√≥ key n√†o</p>';
                    return;
                }

                const unsold = keys.filter(k => k.is_sold === 0);
                const sold = keys.filter(k => k.is_sold === 1);

                keysList.innerHTML = `
                    <div style="margin-bottom: 20px;">
                        <h4 style="color: #28a745;">‚úÖ Keys ch∆∞a b√°n (${unsold.length})</h4>
                        <div style="max-height: 400px; overflow-y: auto;">
                            ${unsold.map(k => `
                                <div id="key-row-${k.id}" style="display: flex; gap: 10px; align-items: center; padding: 10px; background: white; margin-bottom: 5px; border-radius: 5px;">
                                    <input 
                                        type="text" 
                                        id="key-input-${k.id}" 
                                        value="${k.key}" 
                                        style="flex: 1; padding: 8px; border: 2px solid #ddd; border-radius: 5px; font-family: monospace;"
                                        readonly
                                    />
                                    <button onclick="enableEdit(${k.id})" id="edit-btn-${k.id}" style="background: #007bff; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; white-space: nowrap;">
                                        ‚úèÔ∏è S·ª≠a
                                    </button>
                                    <button onclick="saveKey(${k.id})" id="save-btn-${k.id}" style="display: none; background: #28a745; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; white-space: nowrap;">
                                        üíæ L∆∞u
                                    </button>
                                    <button onclick="cancelEdit(${k.id}, '${k.key}')" id="cancel-btn-${k.id}" style="display: none; background: #6c757d; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; white-space: nowrap;">
                                        ‚ùå H·ªßy
                                    </button>
                                    <button onclick="deleteIndividualKey(${k.id}, '${k.key}')" style="background: #dc3545; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; white-space: nowrap;">
                                        üóëÔ∏è X√≥a
                                    </button>
                                </div>
                            `).join('') || '<p style="opacity: 0.7;">Kh√¥ng c√≥</p>'}
                        </div>
                    </div>
                    <div>
                        <h4 style="color: #6c757d;">‚ùå Keys ƒë√£ b√°n (${sold.length})</h4>
                        <div style="max-height: 200px; overflow-y: auto;">
                            ${sold.map(k => `
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #f8f9fa; margin-bottom: 5px; border-radius: 5px; opacity: 0.7;">
                                    <code style="flex: 1;">${k.key}</code>
                                    <button onclick="deleteIndividualKey(${k.id}, '${k.key}')" style="background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer;">
                                        üóëÔ∏è X√≥a
                                    </button>
                                </div>
                            `).join('') || '<p style="opacity: 0.7;">Kh√¥ng c√≥</p>'}
                        </div>
                    </div>
                `;
            } catch (e) {
                keysList.innerHTML = `<p style="color: #dc3545;">‚ùå L·ªói: ${e.message}</p>`;
            }
        }

        function enableEdit(keyId) {
            const input = document.getElementById(`key-input-${keyId}`);
            const editBtn = document.getElementById(`edit-btn-${keyId}`);
            const saveBtn = document.getElementById(`save-btn-${keyId}`);
            const cancelBtn = document.getElementById(`cancel-btn-${keyId}`);
            
            input.readOnly = false;
            input.style.borderColor = '#007bff';
            input.focus();
            input.select();
            
            editBtn.style.display = 'none';
            saveBtn.style.display = 'block';
            cancelBtn.style.display = 'block';
        }

        function cancelEdit(keyId, originalKey) {
            const input = document.getElementById(`key-input-${keyId}`);
            const editBtn = document.getElementById(`edit-btn-${keyId}`);
            const saveBtn = document.getElementById(`save-btn-${keyId}`);
            const cancelBtn = document.getElementById(`cancel-btn-${keyId}`);
            
            input.value = originalKey;
            input.readOnly = true;
            input.style.borderColor = '#ddd';
            
            editBtn.style.display = 'block';
            saveBtn.style.display = 'none';
            cancelBtn.style.display = 'none';
        }

        async function saveKey(keyId) {
            const input = document.getElementById(`key-input-${keyId}`);
            const newKey = input.value.trim();
            
            if (!newKey) {
                showAlert('‚ùå Key kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng', 'error');
                return;
            }
            
            try {
                const res = await fetch(`${API_BASE}/admin/key/${keyId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ newKey })
                });
                const data = await res.json();
                
                if (data.ok) {
                    showAlert(`‚úÖ ƒê√£ c·∫≠p nh·∫≠t key: ${data.oldKey} ‚Üí ${data.newKey}`);
                    input.readOnly = true;
                    input.style.borderColor = '#ddd';
                    
                    document.getElementById(`edit-btn-${keyId}`).style.display = 'block';
                    document.getElementById(`save-btn-${keyId}`).style.display = 'none';
                    document.getElementById(`cancel-btn-${keyId}`).style.display = 'none';
                    
                    // Update cancel button with new original value
                    const cancelBtn = document.getElementById(`cancel-btn-${keyId}`);
                    cancelBtn.setAttribute('onclick', `cancelEdit(${keyId}, '${newKey}')`);
                    
                    loadStats();
                } else {
                    showAlert(`‚ùå L·ªói: ${data.error}`, 'error');
                }
            } catch (e) {
                showAlert(`‚ùå L·ªói k·∫øt n·ªëi: ${e.message}`, 'error');
            }
        }

        async function deleteIndividualKey(keyId, keyText) {
            if (!confirm(`‚ö†Ô∏è X√≥a key: ${keyText}?`)) {
                return;
            }

            try {
                const res = await fetch(`${API_BASE}/admin/key/${keyId}`, {
                    method: 'DELETE'
                });
                const data = await res.json();
                if (data.ok) {
                    showAlert(`‚úÖ ƒê√£ x√≥a key`);
                    loadKeysForProduct();
                    loadStats();
                } else {
                    showAlert(`‚ùå L·ªói: ${data.error}`, 'error');
                }
            } catch (e) {
                showAlert(`‚ùå L·ªói k·∫øt n·ªëi: ${e.message}`, 'error');
            }
        }

        // Replace Key Form
        document.getElementById('replaceKeyForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const productId = parseInt(document.getElementById('replaceProductSelect').value);
            const oldKey = document.getElementById('replaceOldKey').value.trim();
            const newKey = document.getElementById('replaceNewKey').value.trim();
            
            if (!productId) {
                showAlert('‚ùå Vui l√≤ng ch·ªçn s·∫£n ph·∫©m', 'error');
                return;
            }
            
            if (!oldKey || !newKey) {
                showAlert('‚ùå Vui l√≤ng nh·∫≠p key c≈© v√† key m·ªõi', 'error');
                return;
            }
            
            try {
                const res = await fetch(`${API_BASE}/admin/key/replace`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ productId, oldKey, newKey })
                });
                const data = await res.json();
                
                if (data.ok) {
                    showAlert(`‚úÖ ƒê√£ thay th·∫ø key: ${oldKey} ‚Üí ${newKey}`);
                    document.getElementById('replaceKeyForm').reset();
                    
                    // Reload keys list if viewing the same product
                    const viewingProductId = document.getElementById('viewKeysProductSelect').value;
                    if (viewingProductId == productId) {
                        loadKeysForProduct();
                    }
                    loadStats();
                } else {
                    showAlert(`‚ùå L·ªói: ${data.error}`, 'error');
                }
            } catch (e) {
                showAlert(`‚ùå L·ªói k·∫øt n·ªëi: ${e.message}`, 'error');
            }
        });

        // Coupon Form
        document.getElementById('couponForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const code = document.getElementById('couponCode').value.trim().toUpperCase();
            const discount = parseInt(document.getElementById('couponDiscount').value);
            const maxUses = parseInt(document.getElementById('couponMaxUses').value);
            const expiry = document.getElementById('couponExpiry').value || null;
            const active = document.getElementById('couponActive').checked;

            try {
                const res = await fetch(`${API_BASE}/admin/coupon`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code, discount, maxUses, expiry, active })
                });
                const data = await res.json();
                if (data.ok) {
                    showAlert(`‚úÖ ƒê√£ t·∫°o m√£ gi·∫£m gi√° "${code}" (-${discount}%)`);
                    document.getElementById('couponForm').reset();
                    document.getElementById('couponActive').checked = true;
                    document.getElementById('couponMaxUses').value = -1;
                    loadCoupons();
                } else {
                    showAlert(`‚ùå L·ªói: ${data.error}`, 'error');
                }
            } catch (e) {
                showAlert(`‚ùå L·ªói k·∫øt n·ªëi: ${e.message}`, 'error');
            }
        });

        async function loadCoupons() {
            try {
                const res = await fetch(`${API_BASE}/admin/coupons`);
                const coupons = await res.json();
                const container = document.getElementById('couponsList');
                
                if (coupons.length === 0) {
                    container.innerHTML = '<p style="text-align: center; opacity: 0.7;">Ch∆∞a c√≥ m√£ gi·∫£m gi√° n√†o</p>';
                    return;
                }

                container.innerHTML = coupons.map(c => {
                    const expired = c.expires_at && new Date(c.expires_at) < new Date();
                    const maxedOut = c.max_uses > 0 && c.used_count >= c.max_uses;
                    const status = !c.active ? 'üî¥ T·∫Øt' : expired ? '‚è∞ H·∫øt h·∫°n' : maxedOut ? 'üö´ H·∫øt l∆∞·ª£t' : 'üü¢ Ho·∫°t ƒë·ªông';
                    
                    return `
                        <div class="panel" style="background: ${c.active && !expired && !maxedOut ? '#d4edda' : '#f8d7da'}; margin-bottom: 10px;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <h4 style="margin: 0 0 5px 0;">üéüÔ∏è ${c.code}</h4>
                                    <p style="margin: 5px 0;">Gi·∫£m: <strong>${c.discount_percent}%</strong></p>
                                    <p style="margin: 5px 0;">ƒê√£ d√πng: <strong>${c.used_count}</strong>${c.max_uses > 0 ? ` / ${c.max_uses}` : ' (Kh√¥ng gi·ªõi h·∫°n)'}</p>
                                    ${c.expires_at ? `<p style="margin: 5px 0;">H·∫øt h·∫°n: ${new Date(c.expires_at).toLocaleString('vi-VN')}</p>` : '<p style="margin: 5px 0;">Kh√¥ng h·∫øt h·∫°n</p>'}
                                    <p style="margin: 5px 0;">Tr·∫°ng th√°i: ${status}</p>
                                </div>
                                <div>
                                    <button onclick="toggleCoupon('${c.code}', ${!c.active})" class="btn" style="background: ${c.active ? '#dc3545' : '#28a745'}; margin-right: 5px;">
                                        ${c.active ? '‚ùå T·∫Øt' : '‚úÖ B·∫≠t'}
                                    </button>
                                    <button onclick="deleteCoupon('${c.code}')" class="btn" style="background: #dc3545;">üóëÔ∏è X√≥a</button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (e) {
                document.getElementById('couponsList').innerHTML = `<p style="color: #dc3545;">‚ùå L·ªói: ${e.message}</p>`;
            }
        }

        async function toggleCoupon(code, active) {
            if (!confirm(`${active ? 'B·∫≠t' : 'T·∫Øt'} m√£ gi·∫£m gi√° ${code}?`)) return;
            
            try {
                const res = await fetch(`${API_BASE}/admin/coupon/${code}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ active })
                });
                const data = await res.json();
                if (data.ok) {
                    showAlert(`‚úÖ ƒê√£ ${active ? 'b·∫≠t' : 't·∫Øt'} m√£ ${code}`);
                    loadCoupons();
                } else {
                    showAlert(`‚ùå L·ªói: ${data.error}`, 'error');
                }
            } catch (e) {
                showAlert(`‚ùå L·ªói: ${e.message}`, 'error');
            }
        }

        async function deleteCoupon(code) {
            if (!confirm(`X√ìA Vƒ®NH VI·ªÑN m√£ gi·∫£m gi√° ${code}?`)) return;
            
            try {
                const res = await fetch(`${API_BASE}/admin/coupon/${code}`, { method: 'DELETE' });
                const data = await res.json();
                if (data.ok) {
                    showAlert(`‚úÖ ƒê√£ x√≥a m√£ ${code}`);
                    loadCoupons();
                } else {
                    showAlert(`‚ùå L·ªói: ${data.error}`, 'error');
                }
            } catch (e) {
                showAlert(`‚ùå L·ªói: ${e.message}`, 'error');
            }
        }

        // Initialize
        window.addEventListener('load', () => {
            loadStats();
            loadCategories();
            loadProducts();
            loadCategoriesForDelete();
        });
    </script>
</body>
</html>
